<section class="container check-out-view">
    <div class="panel panel-default cart-view-summary col-md-3 col-md-offset-1 col-md-push-8">
        <div class="panel-heading">
            <h3 class="panel-title panel-primary">
                Checkout Summary
            </h3>
        </div>
        <div class="panel-body text-left">
            <div ng-if="!user.Permissions.contains('HidePricing')" style="padding: 10px;">
                <p>Items: {{currentOrder.LineItems.length}}</p>
                <p>Subtotal: {{currentOrder.Subtotal | currency}}</p>
                <p>Shipping Costs: {{currentOrder.ShippingCost | currency}}</p>
                <p>Tax: {{currentOrder.Tax || 0 | currency}}</p>
                <p ng-show="currentOrder.Coupon">{{currentOrder.Coupon.Label}}: {{currentOrder.Coupon.OrderDiscount * -1 | currency}}</p>
                <hr/>
                <p>Total: {{currentOrder.Total | currency}}</p>
                <p ng-if="user.Company.TaxMethod != 'NoTax'"><label>{{ user.Company.SiteText.ShippingDisclaimer }}</label></p>
            </div>
        </div>
        <div class="panel-footer">
            <p class="alert alert-warning" ng-show="cart_shipping.$invalid || cart_order.$invalid || cart_billing.$invalid">Please correct all errors to submit order.</p>
            <!--- TODO below submit order button needs to redirect to ORDERS page and display the submitted order upon submission --->
            <button class="btn btn-primary" ng-show="currentOrder" ng-click="submitOrder()" ng-disabled="cart_shipping.$invalid || cart_order.$invalid || cart_billing.$invalid">
                Submit Order
            </button>
        </div>
    </div>

    <div class="panel panel-primary col-md-8 col-md-pull-4 check-out-view-types" ng-show="currentOrder && currentOrder.isEditable">
        <div class="panel-heading">
            <h3 ng-click="checkOutSection = 'order'" class="panel-title panel-primary">
                    <i ng-class="{'fa fa-times-circle': cart_order.$invalid, 'fa fa-check': !cart_order.$invalid }"></i>
                Order
            </h3>
        </div>
        <form name="cart_order">
            <div ng-show="checkOutSection == 'order'" ng-show="currentOrder" class="panel-body check-out-view-order">
                <div class="error_list">
                    <span class="alert-error" ng-show="cart_order.orderid.$invalid">Please enter a valid Order ID</span><br />
                </div>
                <div ng-if="user.Permissions.contains('EditPOID')" ng-invalid>
                    <label>{{user.Company.SiteText.OrderID || 'Order ID'}}:</label>
                    <br />
                    <div class="input-group">
                        <span ng-if="user.Permissions.contains('AllowAutoGenPOID')" class="input-group-addon">
                            <input type='checkbox' ng-click="currentOrder.ExternalID = currentOrder.autoID ? 'auto' : ''; showOrderID = ! showOrderID" ng-model='currentOrder.autoID' />
                            Use system-generated ID
                        </span>
                        <input name="orderid" ng-disabled='currentOrder.autoID' type='text' ng-model="currentOrder.ExternalID" placeholder="Order ID" required ui-mask="{{user.Company.POIDMask}}" />
                    </div>
                </div>
                <hr />
                <label>Comments:</label>
                <br />
                <textarea rows="5" cols="100" ng-model="currentOrder.Comments" />
                <label ng-if="user.Permissions.contains('CostCenterPerOrder') && !user.Permissions.contains('CostCenterPerLine')">
                    <hr />
                    <select required ng-if="user.CostCenters.length > 1 && !user.Permissions.contains('FreeFormCostCenter')" ng-options="center.Name as center.Name for center in user.CostCenters" ng-model="currentOrder.CostCenter"></select>
                    <input ng-if="user.Permissions.contains('FreeFormCostCenter')" ng-model="currentOrder.CostCenter" type='text' required placeholder="Cost Center" />
                    <span ng-if="user.CostCenters.length == 1 && !user.Permissions.contains('FreeFormCostCenter')">
                        {{user.Company.SiteText.CostCenter || 'Cost Center'}}: {{currentOrder.CostCenter}}
                    </span>
                </label>
                <ul ng-if="user.OrderFields">
                    <hr />
                    <li ng-repeat="field in currentOrder.OrderFields">
                        <customtextfield customfield="field" ng-if="field.ControlType == 'Text'" ng-required="field.IsRequired" />
                        <customselectionfield customfield="field" ng-if="field.ControlType == 'Selection'" ng-required="field.IsRequired" />
                    </li>
                </ul>
            </div>
        </form>

        <div class="panel-heading">
            <h3 ng-click="checkOutSection = 'shipping'" class="panel-title panel-primary">
                    <i ng-class="{'fa fa-times-circle': cart_shipping.$invalid, 'fa fa-check': !cart_shipping.$invalid }"></i>
                Shipping
            </h3>
        </div>
        <form name="cart_shipping">
            <div ng-show="checkOutSection == 'shipping'" ng-show="currentOrder"  class="panel-body check-out-view-shipping"  >
                <div class="error_list">
                    <p class="alert-error" ng-show="cart_shipping.shippingAddress.$invalid">Please choose a shipping address</p>
                    <p class="alert-error" ng-show="cart_shipping.shippingMethod.$invalid">Please choose a shipping method</p>
                </div>
                <button type="button" class="btn btn-xs btn-danger" redirect="/address" tabindex="-1">Add New Address</button>
                <button type="button" ng-click="shipToMultipleAddresses = !shipToMultipleAddresses" class="btn btn-xs btn-warning"
                        ng-show="user.Permissions.contains('ShipToMultipleAddresses') && currentOrder.LineItems.length > 1 && user.ShipMethod != null">Ship to multiple addresses</button>
                <div ng-show="!shipToMultipleAddresses">
                    <div>
                        <h5>
                            Shipping Address
                        </h5>
                        <select name="shippingAddress"
                                ng-change="setShipAddressAtOrderLevel()"
                                ng-options="address.ID as address.AddressName for address in addresses | filter:{IsShipping:true}"
                                ng-model="currentOrder.ShipAddressID"
                                ng-required="!shipToMultipleAddresses" />
                    </div>
                    <div ng-show="user.ShipMethod != null">
                        <h5>
                            Shipping Method
                        </h5>
                        <select ng-change="updateShipper()"
                                ng-show="user.ShipMethod.ShipperSelectionType == 'UserDropDown'"
                                ng-options="shipper.ID as shipper.Name for shipper in shippers"
                                ng-model="currentOrder.ShipperID"
                                ng-required="!shipToMultipleAddresses && user.ShipMethod != null" />
                    </div>
                </div>
                <div ng-show="shipToMultipleAddresses">
                    <ul>
                        <li ng-repeat="item in currentOrder.LineItems">
                            {{item.ProductIDText}} |
                            {{item.Quantity}} |
                            {{item.DateNeeded | date:'MM/dd/yyyy' }}
                            <select name="shippingAddress"
                                    ng-options="address.ID as address.AddressName for address in addresses | filter:{IsShipping:true}"
                                    ng-model="item.ShipAddressID"
                                    ng-required="shipToMultipleAddresses" /> ~
                            <select ng-change="updateShipper(item)"
                                    ng-show="user.ShipMethod.ShipperSelectionType == 'UserDropDown'"
                                    ng-options="shipper.ID as shipper.Name for shipper in shippers | noliverates"
                                    ng-model="item.ShipperID"
                                    ng-required="shipToMultipleAddresses && user.ShipMethod != null" />
                        </li>
                    </ul>
                </div>
                <input ng-if="user.ShipMethod.AskForAccountNumber" placeholder="Shipping Account Number" type="text" ng-model="currentOrder.LineItems[0].ShipAccount" />
            </div>
        </form>

        <div class="panel-heading">
            <h3 ng-click="checkOutSection = 'billing'" class="panel-title panel-primary">
                <i ng-class="{'fa fa-times-circle': cart_billing.$invalid, 'fa fa-check': !cart_billing.$invalid }"></i>
                Billing
            </h3>
        </div>
        <form name="cart_billing">
            <div ng-show="checkOutSection == 'billing'" ng-show="currentOrder" class="panel-body check-out-view-billing">
                <div class="error_list">
                    <p class="alert-error" ng-show="cart_billing.billingAddress.$invalid">Please select a billing address</p>
                    <p class="alert-error" ng-show="cart_billing.paymentMethod.$invalid">Please select a payment method</p>
                </div>
                <h5>
                    Billing Address
                </h5>
                <select name="billingAddress" ng-options="address.ID as address.AddressName for address in addresses | filter:{IsBilling:true}" ng-model="currentOrder.BillAddressID" required />
                <button type="button" class="btn btn-xs btn-danger" redirect="/address"  tabindex="-1">Add New Address</button>
                <paymentselector />
                <div ng-show="user.Permissions.contains('ViewPromotions')">
                    <div ng-show="!currentOrder.Coupon">
                        <span>{{user.Company.SiteText.PromotionCode || 'Promotion Code'}}: </span>
                        <input type="text" ng-model="coupon" />
                        <button type="button" class="btn btn-xs btn-danger" ng-click="applyCoupon()">{{user.Company.SiteText.Apply || 'Apply'}}</button><br />
                        <span ng-show="couponError" class="ui-state-error">{{couponError}}</span>
                    </div>
                    <h5 ng-show="currentOrder.Coupon">
                        <p>Coupon: {{currentOrder.Coupon.CouponCode}}<span><i ng-click="removeCoupon()" ng-class="{'fa fa-eraser': currentOrder.Coupon }"></i></span></p>
                    </h5>
                    <div ng-show="currentOrder.Coupon" class="text-danger">
                        <p ng-bind="currentOrder.Coupon.Description"></p>
                        <span ng-show="currentOrder.Coupon.ExpirationDate">Expires: {{currentOrder.Coupon.ExpirationDate | date:'MM/dd/yyyy'}}</span>
                    </div>
                </div>
                <div ng-show="currentOrder.Approvals" class="check-out-approvals">
                    <h5>APPROVALS</h5>
                    <approvalrulelist order="currentOrder" />
                </div>
                <div ng-show="user.Permissions.contains('SendOrderNotificationToOthers')">
                    <div>
                        <h5>
                            Email Notification
                        </h5>
                        <input ng-disabled="cart_shipping.$invalid || cart_order.$invalid || cart_billing.$invalid" type="text" ng-model="currentOrder.ExternalOrderDetailRecipients" />
                    </div>
                </div>
            </div>
        </form>

        <div class="panel-footer check-out-view-types">
            <div class="check-out-view-btn-group" ng-show="currentOrder">
                <span class="btn-group">
                    <button class="btn btn-default cart-view-btn-save" ng-click="saveChanges()">
                        {{user.Company.SiteText.SaveChanges || 'Save Changes'}}
                    </button>
                    <button class="btn btn-default cart-view-btn-cancel" ng-click="cancelOrder()">
                        Cancel Order
                    </button>
                </span>
                <button class="btn btn-default cart-view-btn-continue" ng-click="continueShopping()" style="float: right;">
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>
</section>